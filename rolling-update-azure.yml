---

- name: get sql server details
  hosts: '*sql_server'
  vars:
    ansible_port: 5986
    ansible_connection: winrm
    ansible_winrm_transport: credssp
    ansible_winrm_server_cert_validation: ignore
  pre_tasks:
    - name: set ad server ip
      add_host:
        name: sql_server
        ip_address:  "{{ ansible_ip_addresses[0] | default(ansible_host) | default(ansible_ssh_host) }}"

    - debug:
        var: hostvars['sql_server']['ip_address']

- name: rolling update
  hosts: '*iis'
  serial: "50%"
  vars:
    ansible_port: 5986
    ansible_connection: winrm
    ansible_winrm_transport: credssp
    ansible_winrm_server_cert_validation: ignore
    azure_prefix: DEMO
    azure_resource_group_name: rg_{{ azure_prefix }}

  pre_tasks:

    - name: set ip address of sql server
      set_fact:
        sql_server_ip_address: "{{ hostvars['sql_server']['ip_address'] }}"
      when:
        - hostvars['sql_server']['ip_address'] is defined
      run_once: yes

    - name: set targets from list
      set_fact:
        backend_removed_list: "{{ backend_removed_list|default([]) + [ {'ip_address': hostvars[item].ansible_host} ] }}"
      with_items:
        - "{{ groups['role_iis'] | difference(play_hosts) }}"
      run_once: yes

    - debug:
        var: backend_removed_list
      run_once: yes

    - name: ensure systems are taken out of Application Gateway pool
      azure_rm_appgateway:
        resource_group: "{{ azure_resource_group_name }}"
        name: "ag_{{ azure_prefix }}"
        backend_address_pools:
          - backend_addresses: "{{ backend_removed_list }}"
            name: ag_backend_address_pool_{{ azure_prefix }}
      delegate_to: localhost
      become: no
      vars:
        ansible_connection: local
      run_once: yes

  roles:
    - music-store-iis

  post_tasks:

    - name: set targets from list
      set_fact:
        backend_added_list: "{{ backend_added_list|default([]) + [ {'ip_address': hostvars[item].ansible_host} ] }}"
      with_items:
        - "{{ groups['role_iis'] + [inventory_hostname] }}"

    - debug:
        var: backend_added_list

    - name: ensure systems are taken out of Application Gateway pool
      azure_rm_appgateway:
        resource_group: "{{ azure_resource_group_name }}"
        name: "ag_{{ azure_prefix }}"
        backend_address_pools:
          - backend_addresses: "{{ backend_added_list }}"
            name: ag_backend_address_pool_{{ azure_prefix }}
      delegate_to: localhost
      become: no
      vars:
        ansible_connection: local

